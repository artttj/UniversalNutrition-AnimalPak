#!/bin/bash
set -e

cd $(dirname $0)
BIN_DIR=$(pwd)
COMPOSE_DIR=${BIN_DIR}/../..
CICD_DIR=${BIN_DIR}/../../cicd
cd "${COMPOSE_DIR}/"

export COMPOSE_HTTP_TIMEOUT=600

if ! (ls compose/files/db/*.sql >/dev/null 2>&1 || ls compose/files/db/*.gz >/dev/null 2>&1); then
  "${CICD_DIR}/get-db.sh"
fi

COMPOSE_DEV="yes"
COMPOSE_CRON="no"
INTIALIZE_LOCAL="no"

COMPOSE_ARGS="-f docker-compose.yml"
for arg in "$@"
do
  case $arg in
    -h|--help)
      echo "Supported arguments:"
      echo "  --enable-cron      Enable php cronjob container"
      echo "  --disable-dev      No dev stack"
      echo "  --init             Initialize local development environment"
      exit
      ;;
    --init)
      INITIALIZE_LOCAL="yes"
      ;;
    --enable-cron)
      COMPOSE_CRON="yes"
      ;;
    --disable-dev)
      COMPOSE_DEV="no"
      ;;
    esac
done

if [[ ${INITIALIZE_LOCAL} = "yes" ]]; then
  "${BIN_DIR}/init-local" ${COMPOSE_ARGS}
fi

if [[ ${COMPOSE_DEV} = "yes" ]]; then
   COMPOSE_ARGS="${COMPOSE_ARGS} -f docker-compose-dev.yml"
fi

if [[ ${COMPOSE_CRON} = "yes" ]]; then
  COMPOSE_ARGS="${COMPOSE_ARGS} -f docker-compose-cron.yml"
fi


docker-compose ${COMPOSE_ARGS} up -d
